{"version":3,"sources":["../src/squirrelPack.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\r\nimport { Arch, debug, exec, log, spawn } from \"builder-util\"\r\nimport { copyFile, walk } from \"builder-util/out/fs\"\r\nimport { compute7zCompressArgs } from \"app-builder-lib/out/targets/archive\"\r\nimport { execWine, prepareWindowsExecutableArgs as prepareArgs } from \"app-builder-lib/out/wine\"\r\nimport { WinPackager } from \"app-builder-lib/out/winPackager\"\r\nimport { createWriteStream, ensureDir, remove, stat, unlink, writeFile } from \"fs-extra\"\r\nimport * as path from \"path\"\r\n\r\nconst archiver = require(\"archiver\")\r\n\r\nexport function convertVersion(version: string): string {\r\n  const parts = version.split(\"-\")\r\n  const mainVersion = parts.shift()\r\n  if (parts.length > 0) {\r\n    return [mainVersion, parts.join(\"-\").replace(/\\./g, \"\")].join(\"-\")\r\n  }\r\n  else {\r\n    return mainVersion!\r\n  }\r\n}\r\n\r\nfunction syncReleases(outputDirectory: string, options: SquirrelOptions) {\r\n  log.info(\"syncing releases to build delta package\")\r\n  const args = prepareArgs([\"-u\", options.remoteReleases!, \"-r\", outputDirectory], path.join(options.vendorPath, \"SyncReleases.exe\"))\r\n  if (options.remoteToken) {\r\n    args.push(\"-t\", options.remoteToken)\r\n  }\r\n  return spawn(process.platform === \"win32\" ? path.join(options.vendorPath, \"SyncReleases.exe\") : \"mono\", args)\r\n}\r\n\r\nexport interface SquirrelOptions {\r\n  vendorPath: string\r\n  remoteReleases?: string\r\n  remoteToken?: string\r\n  loadingGif?: string\r\n  productName: string\r\n  appId?: string\r\n  name: string\r\n  packageCompressionLevel?: number\r\n  version: string\r\n  msi?: any\r\n\r\n  description?: string\r\n  iconUrl?: string\r\n  authors?: string\r\n  extraMetadataSpecs?: string\r\n  copyright?: string\r\n}\r\n\r\nexport interface OutFileNames {\r\n  setupFile: string\r\n  packageFile: string\r\n}\r\n\r\nexport class SquirrelBuilder {\r\n  constructor(private readonly options: SquirrelOptions, private readonly outputDirectory: string, private readonly packager: WinPackager) {\r\n  }\r\n\r\n  async buildInstaller(outFileNames: OutFileNames, appOutDir: string, outDir: string, arch: Arch) {\r\n    const packager = this.packager\r\n    const dirToArchive = await packager.info.tempDirManager.createTempDir({prefix: \"squirrel-windows\"})\r\n    const outputDirectory = this.outputDirectory\r\n    const options = this.options\r\n    const appUpdate = path.join(dirToArchive, \"Update.exe\")\r\n    await Promise.all([\r\n      copyFile(path.join(options.vendorPath, \"Update.exe\"), appUpdate)\r\n        .then(() => packager.sign(appUpdate)),\r\n      Promise.all([remove(`${outputDirectory.replace(/\\\\/g, \"/\")}/*-full.nupkg`), remove(path.join(outputDirectory, \"RELEASES\"))])\r\n        .then(() => ensureDir(outputDirectory))\r\n    ])\r\n\r\n    if (options.remoteReleases) {\r\n      await syncReleases(outputDirectory, options)\r\n    }\r\n\r\n    const version = convertVersion(options.version)\r\n    const nupkgPath = path.join(outputDirectory, outFileNames.packageFile)\r\n    const setupPath = path.join(outputDirectory, outFileNames.setupFile)\r\n\r\n    await Promise.all<any>([\r\n      pack(options, appOutDir, appUpdate, nupkgPath, version, packager),\r\n      copyFile(path.join(options.vendorPath, \"Setup.exe\"), setupPath),\r\n      copyFile(options.loadingGif ? path.resolve(packager.projectDir, options.loadingGif) : path.join(options.vendorPath, \"install-spinner.gif\"), path.join(dirToArchive, \"background.gif\")),\r\n    ])\r\n\r\n    // releasify can be called only after pack nupkg and nupkg must be in the final output directory (where other old version nupkg can be located)\r\n    await this.releasify(nupkgPath, outFileNames.packageFile)\r\n      .then(it => writeFile(path.join(dirToArchive, \"RELEASES\"), it))\r\n\r\n    const embeddedArchiveFile = await this.createEmbeddedArchiveFile(nupkgPath, dirToArchive)\r\n\r\n    await execWine(path.join(options.vendorPath, \"WriteZipToSetup.exe\"), null, [setupPath, embeddedArchiveFile])\r\n\r\n    await packager.signAndEditResources(setupPath, arch, outDir)\r\n    if (options.msi && process.platform === \"win32\") {\r\n      const outFile = outFileNames.setupFile.replace(\".exe\", \".msi\")\r\n      await msi(options, nupkgPath, setupPath, outputDirectory, outFile)\r\n      // rcedit can only edit .exe resources\r\n      await packager.sign(path.join(outputDirectory, outFile))\r\n    }\r\n  }\r\n\r\n  private async releasify(nupkgPath: string, packageName: string) {\r\n    const args = [\r\n      \"--releasify\", nupkgPath,\r\n      \"--releaseDir\", this.outputDirectory\r\n    ]\r\n    const out = (await execSw(this.options, args)).trim()\r\n    if (debug.enabled) {\r\n      debug(`Squirrel output: ${out}`)\r\n    }\r\n\r\n    const lines = out.split(\"\\n\")\r\n    for (let i = lines.length - 1; i > -1; i--) {\r\n      const line = lines[i]\r\n      if (line.includes(packageName)) {\r\n        return line.trim()\r\n      }\r\n    }\r\n\r\n    throw new Error(`Invalid output, cannot find last release entry, output: ${out}`)\r\n  }\r\n\r\n  private async createEmbeddedArchiveFile(nupkgPath: string, dirToArchive: string) {\r\n    const embeddedArchiveFile = await this.packager.getTempFile(\"setup.zip\")\r\n    await exec(path7za, compute7zCompressArgs(\"zip\", {\r\n      isRegularFile: true,\r\n      compression: this.packager.compression,\r\n    }).concat(embeddedArchiveFile, \".\"), {\r\n      cwd: dirToArchive,\r\n    })\r\n    await exec(path7za, compute7zCompressArgs(\"zip\", {\r\n      isRegularFile: true,\r\n      compression: \"store\" /* nupkg is already compressed */,\r\n    }).concat(embeddedArchiveFile, nupkgPath))\r\n    return embeddedArchiveFile\r\n  }\r\n}\r\n\r\nasync function pack(options: SquirrelOptions, directory: string, updateFile: string, outFile: string, version: string, packager: WinPackager) {\r\n  // SW now doesn't support 0-level nupkg compressed files. It means that we are forced to use level 1 if store level requested.\r\n  const archive = archiver(\"zip\", {zlib: {level: Math.max(1, (options.packageCompressionLevel == null ? 9 : options.packageCompressionLevel))}})\r\n  const archiveOut = createWriteStream(outFile)\r\n  const archivePromise = new Promise((resolve, reject) => {\r\n    archive.on(\"error\", reject)\r\n    archiveOut.on(\"error\", reject)\r\n    archiveOut.on(\"close\", resolve)\r\n  })\r\n  archive.pipe(archiveOut)\r\n\r\n  const author = options.authors\r\n  const copyright = options.copyright || `Copyright © ${new Date().getFullYear()} ${author}`\r\n  const nuspecContent = `<?xml version=\"1.0\"?>\r\n<package xmlns=\"http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd\">\r\n  <metadata>\r\n    <id>${options.appId}</id>\r\n    <version>${version}</version>\r\n    <title>${options.productName}</title>\r\n    <authors>${author}</authors>\r\n    <iconUrl>${options.iconUrl}</iconUrl>\r\n    <requireLicenseAcceptance>false</requireLicenseAcceptance>\r\n    <description>${options.description}</description>\r\n    <copyright>${copyright}</copyright>${options.extraMetadataSpecs || \"\"}\r\n  </metadata>\r\n</package>`\r\n  debug(`Created NuSpec file:\\n${nuspecContent}`)\r\n  archive.append(nuspecContent.replace(/\\n/, \"\\r\\n\"), {name: `${options.name}.nuspec`})\r\n\r\n  //noinspection SpellCheckingInspection\r\n  archive.append(`<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<Relationships xmlns=\"http://schemas.openxmlformats.org/package/2006/relationships\">\r\n  <Relationship Type=\"http://schemas.microsoft.com/packaging/2010/07/manifest\" Target=\"/${options.name}.nuspec\" Id=\"Re0\" />\r\n  <Relationship Type=\"http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties\" Target=\"/package/services/metadata/core-properties/1.psmdcp\" Id=\"Re1\" />\r\n</Relationships>`.replace(/\\n/, \"\\r\\n\"), {name: \".rels\", prefix: \"_rels\"})\r\n\r\n  //noinspection SpellCheckingInspection\r\n  archive.append(`<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<Types xmlns=\"http://schemas.openxmlformats.org/package/2006/content-types\">\r\n  <Default Extension=\"rels\" ContentType=\"application/vnd.openxmlformats-package.relationships+xml\" />\r\n  <Default Extension=\"nuspec\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"pak\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"asar\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"bin\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"dll\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"exe\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"dat\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"psmdcp\" ContentType=\"application/vnd.openxmlformats-package.core-properties+xml\" />\r\n  <Default Extension=\"diff\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"bsdiff\" ContentType=\"application/octet\" />\r\n  <Default Extension=\"shasum\" ContentType=\"text/plain\" />\r\n  <Default Extension=\"mp3\" ContentType=\"audio/mpeg\" />\r\n  <Default Extension=\"node\" ContentType=\"application/octet\" />\r\n</Types>`.replace(/\\n/, \"\\r\\n\"), {name: \"[Content_Types].xml\"})\r\n\r\n  archive.append(`<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<coreProperties xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:dcterms=\"http://purl.org/dc/terms/\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n                xmlns=\"http://schemas.openxmlformats.org/package/2006/metadata/core-properties\">\r\n  <dc:creator>${author}</dc:creator>\r\n  <dc:description>${options.description}</dc:description>\r\n  <dc:identifier>${options.appId}</dc:identifier>\r\n  <version>${version}</version>\r\n  <keywords/>\r\n  <dc:title>${options.productName}</dc:title>\r\n  <lastModifiedBy>NuGet, Version=2.8.50926.602, Culture=neutral, PublicKeyToken=null;Microsoft Windows NT 6.2.9200.0;.NET Framework 4</lastModifiedBy>\r\n</coreProperties>`.replace(/\\n/, \"\\r\\n\"), {name: \"1.psmdcp\", prefix: \"package/services/metadata/core-properties\"})\r\n\r\n  archive.file(updateFile, {name: \"Update.exe\", prefix: \"lib/net45\"})\r\n  await encodedZip(archive, directory, \"lib/net45\", options.vendorPath, packager)\r\n  await archivePromise\r\n}\r\n\r\nfunction execSw(options: SquirrelOptions, args: Array<string>) {\r\n  return exec(process.platform === \"win32\" ? path.join(options.vendorPath, \"Update.com\") : \"mono\", prepareArgs(args, path.join(options.vendorPath, \"Update-Mono.exe\")), {\r\n    env: {\r\n      ...process.env,\r\n      SZA_PATH: path7za,\r\n    }\r\n  })\r\n}\r\n\r\nasync function msi(options: SquirrelOptions, nupkgPath: string, setupPath: string, outputDirectory: string, outFile: string) {\r\n  const args = [\r\n    \"--createMsi\", nupkgPath,\r\n    \"--bootstrapperExe\", setupPath\r\n  ]\r\n  await execSw(options, args)\r\n  //noinspection SpellCheckingInspection\r\n  await exec(path.join(options.vendorPath, \"candle.exe\"), [\"-nologo\", \"-ext\", \"WixNetFxExtension\", \"-out\", \"Setup.wixobj\", \"Setup.wxs\"], {\r\n    cwd: outputDirectory,\r\n  })\r\n  //noinspection SpellCheckingInspection\r\n  await exec(path.join(options.vendorPath, \"light.exe\"), [\"-ext\", \"WixNetFxExtension\", \"-sval\", \"-out\", outFile, \"Setup.wixobj\"], {\r\n    cwd: outputDirectory,\r\n  })\r\n\r\n  //noinspection SpellCheckingInspection\r\n  await Promise.all([\r\n    unlink(path.join(outputDirectory, \"Setup.wxs\")),\r\n    unlink(path.join(outputDirectory, \"Setup.wixobj\")),\r\n    unlink(path.join(outputDirectory, outFile.replace(\".msi\", \".wixpdb\"))).catch(e => debug(e.toString())),\r\n  ])\r\n}\r\n\r\nasync function encodedZip(archive: any, dir: string, prefix: string, vendorPath: string, packager: WinPackager) {\r\n  await walk(dir, null, {\r\n    isIncludeDir: true,\r\n    consume: async (file, stats) => {\r\n      if (stats.isDirectory()) {\r\n        return\r\n      }\r\n\r\n      const relativeSafeFilePath = file.substring(dir.length + 1).replace(/\\\\/g, \"/\")\r\n      archive._append(file, {\r\n        name: relativeSafeFilePath,\r\n        prefix,\r\n        stats,\r\n      })\r\n\r\n      // createExecutableStubForExe\r\n      // https://github.com/Squirrel/Squirrel.Windows/pull/1051 Only generate execution stubs for the top-level executables\r\n      if (file.endsWith(\".exe\") && !file.includes(\"squirrel.exe\") && !relativeSafeFilePath.includes(\"/\")) {\r\n        const tempFile = await packager.getTempFile(\"stub.exe\")\r\n        await copyFile(path.join(vendorPath, \"StubExecutable.exe\"), tempFile)\r\n        await execWine(path.join(vendorPath, \"WriteZipToSetup.exe\"), null, [\"--copy-stub-resources\", file, tempFile])\r\n        await packager.sign(tempFile)\r\n\r\n        archive._append(tempFile, {\r\n          name: relativeSafeFilePath.substring(0, relativeSafeFilePath.length - 4) + \"_ExecutionStub.exe\",\r\n          prefix,\r\n          stats: await stat(tempFile),\r\n        })\r\n      }\r\n    }\r\n  })\r\n  archive.finalize()\r\n}"],"sourceRoot":""}
