{"version":3,"sources":["../src/SquirrelWindowsTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { InvalidConfigurationError, log } from \"builder-util\"\r\nimport { getBinFromUrl } from \"app-builder-lib/out/binDownload\"\r\nimport { Arch, getArchSuffix, SquirrelWindowsOptions, Target } from \"app-builder-lib\"\r\nimport { WinPackager } from \"app-builder-lib/out/winPackager\"\r\nimport * as path from \"path\"\r\nimport sanitizeFileName from \"sanitize-filename\"\r\nimport { convertVersion, SquirrelBuilder, SquirrelOptions } from \"./squirrelPack\"\r\n\r\nexport default class SquirrelWindowsTarget extends Target {\r\n  //tslint:disable-next-line:no-object-literal-type-assertion\r\n  readonly options: SquirrelWindowsOptions = {...this.packager.platformSpecificBuildOptions, ...this.packager.config.squirrelWindows} as SquirrelWindowsOptions\r\n\r\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\r\n    super(\"squirrel\")\r\n  }\r\n\r\n  async build(appOutDir: string, arch: Arch) {\r\n    const packager = this.packager\r\n    const version = packager.appInfo.version\r\n    const sanitizedName = sanitizeFileName(this.appName)\r\n\r\n    // tslint:disable-next-line:no-invalid-template-strings\r\n    const setupFile = packager.expandArtifactNamePattern(this.options, \"exe\", arch, \"${productName} Setup ${version}.${ext}\")\r\n    const packageFile = `${sanitizedName}-${convertVersion(version)}-full.nupkg`\r\n\r\n    const installerOutDir = path.join(this.outDir, `squirrel-windows${getArchSuffix(arch)}`)\r\n    const artifactPath = path.join(installerOutDir, setupFile)\r\n\r\n    await packager.info.callArtifactBuildStarted({\r\n      targetPresentableName: \"Squirrel.Windows\",\r\n      file: artifactPath,\r\n      arch,\r\n    })\r\n\r\n    if (arch === Arch.ia32) {\r\n      log.warn(\"For windows consider only distributing 64-bit or use nsis target, see https://github.com/electron-userland/electron-builder/issues/359#issuecomment-214851130\")\r\n    }\r\n\r\n    const distOptions = await this.computeEffectiveDistOptions()\r\n    const squirrelBuilder = new SquirrelBuilder(distOptions as SquirrelOptions, installerOutDir, packager)\r\n    await squirrelBuilder.buildInstaller({setupFile, packageFile}, appOutDir, this.outDir, arch)\r\n\r\n    await packager.info.callArtifactBuildCompleted({\r\n      file: artifactPath,\r\n      target: this,\r\n      arch,\r\n      safeArtifactName: `${sanitizedName}-Setup-${version}${getArchSuffix(arch)}.exe`,\r\n      packager: this.packager,\r\n    })\r\n\r\n    const packagePrefix = `${this.appName}-${convertVersion(version)}-`\r\n    packager.info.dispatchArtifactCreated({\r\n      file: path.join(installerOutDir, `${packagePrefix}full.nupkg`),\r\n      target: this,\r\n      arch,\r\n      packager,\r\n    })\r\n    if (distOptions.remoteReleases != null) {\r\n      packager.info.dispatchArtifactCreated({\r\n        file: path.join(installerOutDir, `${packagePrefix}delta.nupkg`),\r\n        target: this,\r\n        arch,\r\n        packager,\r\n      })\r\n    }\r\n\r\n    packager.info.dispatchArtifactCreated({\r\n      file: path.join(installerOutDir, \"RELEASES\"),\r\n      target: this,\r\n      arch,\r\n      packager,\r\n    })\r\n  }\r\n\r\n  private get appName() {\r\n    return this.options.name || this.packager.appInfo.name\r\n  }\r\n\r\n  async computeEffectiveDistOptions(): Promise<SquirrelOptions> {\r\n    const packager = this.packager\r\n    let iconUrl = this.options.iconUrl\r\n    if (iconUrl == null) {\r\n      const info = await packager.info.repositoryInfo\r\n      if (info != null) {\r\n        iconUrl = `https://github.com/${info.user}/${info.project}/blob/master/${packager.info.relativeBuildResourcesDirname}/icon.ico?raw=true`\r\n      }\r\n\r\n      if (iconUrl == null) {\r\n        throw new InvalidConfigurationError(\"squirrelWindows.iconUrl is not specified, please see https://www.electron.build/configuration/squirrel-windows#SquirrelWindowsOptions-iconUrl\")\r\n      }\r\n    }\r\n\r\n    checkConflictingOptions(this.options)\r\n\r\n    const appInfo = packager.appInfo\r\n    const projectUrl = await appInfo.computePackageUrl()\r\n    const appName = this.appName\r\n    const options: SquirrelOptions = {\r\n      name: appName,\r\n      productName: this.options.name || appInfo.productName,\r\n      appId: this.options.useAppIdAsId ? appInfo.id : appName,\r\n      version: appInfo.version,\r\n      description: appInfo.description,\r\n      // better to explicitly set to empty string, to avoid any nugget errors\r\n      authors: appInfo.companyName || \"\",\r\n      iconUrl,\r\n      extraMetadataSpecs: projectUrl == null ? null : `\\n    <projectUrl>${projectUrl}</projectUrl>`,\r\n      copyright: appInfo.copyright,\r\n      packageCompressionLevel: parseInt((process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL || packager.compression === \"store\" ? 0 : 9) as any, 10),\r\n      vendorPath: await getBinFromUrl(\"Squirrel.Windows\", \"1.9.0\", \"rD3P2v20yZk35X4e41VyU2p0KO4vJqTUFLbkIOe5r9afllInvj3lQAyjIm1W5ys9kDpfrubYap/wPP0URvpMDw==\"),\r\n      ...this.options as any,\r\n    }\r\n\r\n    if (options.remoteToken == null) {\r\n      options.remoteToken = process.env.GH_TOKEN || process.env.GITHUB_TOKEN\r\n    }\r\n\r\n    if (!(\"loadingGif\" in options)) {\r\n      const resourceList = await packager.resourceList\r\n      if (resourceList.includes(\"install-spinner.gif\")) {\r\n        options.loadingGif = path.join(packager.buildResourcesDir, \"install-spinner.gif\")\r\n      }\r\n    }\r\n\r\n    if (this.options.remoteReleases === true) {\r\n      const info = await packager.info.repositoryInfo\r\n      if (info == null) {\r\n        log.warn(\"remoteReleases set to true, but cannot get repository info\")\r\n      }\r\n      else {\r\n        options.remoteReleases = `https://github.com/${info.user}/${info.project}`\r\n        log.info({remoteReleases: options.remoteReleases}, `remoteReleases is set`)\r\n      }\r\n    }\r\n\r\n    return options\r\n  }\r\n}\r\n\r\nfunction checkConflictingOptions(options: any) {\r\n  for (const name of [\"outputDirectory\", \"appDirectory\", \"exe\", \"fixUpPaths\", \"usePackageJson\", \"extraFileSpecs\", \"extraMetadataSpecs\", \"skipUpdateIcon\", \"setupExe\"]) {\r\n    if (name in options) {\r\n      throw new InvalidConfigurationError(`Option ${name} is ignored, do not specify it.`)\r\n    }\r\n  }\r\n\r\n  if (\"noMsi\" in options) {\r\n    log.warn(`noMsi is deprecated, please specify as \"msi\": true if you want to create an MSI installer`)\r\n    options.msi = !options.noMsi\r\n  }\r\n\r\n  const msi = options.msi\r\n  if (msi != null && typeof msi !== \"boolean\") {\r\n    throw new InvalidConfigurationError(`msi expected to be boolean value, but string '\"${msi}\"' was specified`)\r\n  }\r\n}\r\n"],"sourceRoot":""}
